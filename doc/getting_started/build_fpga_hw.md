Building the FPGA bitstream {#page_build_fpga_hw}
============

This page provides information about building the FPGA bitstream


[TOC]

The Quartus projects for the FPGA configuration are located in the folder
`blackchannel/POWERLINK/fpga/altera/boards/[board_name]/[example_name]`.
In order to generate a bitstream for the FPGA of the POWERLINK processor
a few steps need to be executed.
After a successful generation the project directory consists of a
file called `[toplevel].sof` (The bitstream to download) and a file called
`[qsys_system].sopcinfo` (The information about the layout of the embedded
system). These two files can be generated by using the approaches explained in
the next sections.

# The Quartus II IDE    {#sect_gs_build_fpga_hw_quartus}
If you want to generate the bitstream manually a few steps need to be carried
out in the Quartus II IDE.

1. Open the toolchain **Quartus II 13.0sp1**. (**Note:** It is important to use
   **exactly** this version of the toolchain)
2. Open a desired project from
   `blackchannel/POWERLINK/fpga/boards/[platform]/[board_name]/[example_name]
/[project_name].qpf` by clicking on `File -> Open Project`.

   ![Altera Quartus II](altera_quartus.png)
   @image latex altera_quartus.png "Altera Quartus II"

3. Open the tool Qsys with `Tools -> Qsys` and open the file `[toplevel].qsys`.

4. In Qsys select the tab **Generation** and click on the **Generate** button.
    - In Qsys the whole embedded system of the POWERLINK processor is described
      and also the IP-Cores from \ref page_idxipcore are instantiated.
      The ipcore \ref page_plkif provides the option to switch from one
      demo (sn-gpio, etc...) to the other.
    - In addition also the openMAC core can be reconfigured by the user.

      ![Qsys](altera_quartus_qsys.png)
      @image latex altera_quartus_qsys.png "Qsys"

5. After the Qsys generation is finished the file `[qsys_system].sopcinfo` is
   generated in the project folder.

6. In order to generate the bitstream `[toplevel].sof` switch back to Quartus II
   and click on `Processing -> Start Compilation`. The Quartus II synthesis
   can take several minutes.

7. Open `TimeQuest Timing Analyzer -> Slow 1200mV 85C Model -> Fmax Summary`
   and observe the Fmax value which is around 100 MHz (range 99 MHz - 105 Mhz).
   Fmax has to be above 100 MHz.
   Ohterwise the proper function of the hardware with a Fmax under 100 MHz at
   such operating conditions can not be guaranteed.
   Due to different Place & Route results after every compilation, Fmax is
   expected to be above 100 MHz after a new compilation run.

# The script create-this-fpga   {#sect_gs_build_fpga_hw_script}
The bitstream can be generated automatically by using the script called
**create-this-fpga** located in the folder
`blackchannel/POWERLINK/misc/altera_nios2/scripts`.

In order to execute this script open the `Nios II 13.0sp1 Command Shell` or a
shell where the path to the Quartus II toolchain is set.

> **Note:** There are several ways to open `Nios II 13.0sp1 Command Shell`:
> - from Qsys, select `Tools -> Nios II Command Shell`
> - Linux / Unix like environments: execute the script `nios2_command_shell.sh`
>   located in the directory `QUARTUS_INSTALL_DIR/nios2eds`
> - Windows: execute the batch file `Nios II Command Shell.bat` located in the
>   directory `QUARTUS_INSTALL_DIR/nios2eds` or open the
>   `Nios II 13.0sp1 Command Shell` from the Start Menu: `
>   Programs -> Altera 13.0.1 -> Nios II EDS -> Nios II 13.0sp1 Command Shell`


In this shell execute the following command:

      > cd blackchannel/POWERLINK/misc/altera_nios2/scripts
      > ./create-this-fpga ../../../fpga/boards/[platform]/[board_name]/[example_name]
